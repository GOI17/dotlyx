#!/bin/bash

command_exists() {
  type "$1" >/dev/null 2>&1
}

install_pkg() {
  local pkg=$1
  echo "🔧 Installing $pkg..."
  if command_exists apt; then
    sudo apt-get update -y
    sudo apt-get -y install "$pkg" 2>&1
  elif command_exists dnf; then
    sudo dnf -y install "$pkg" 2>&1
  elif command_exists yum; then
    sudo yum -y install "$pkg" 2>&1
  elif command_exists brew; then
    sudo brew install "$pkg" 2>&1
  elif command_exists pacman; then
    sudo pacman -S --noconfirm "$pkg" 2>&1
  else
    echo "❌ No supported package manager found. Please install $pkg manually." >&2
    exit 1
  fi
}

if ! command_exists curl; then
    echo "🔧 curl is not installed. Installing curl..."
    install_pkg curl
fi

if ! command_exists git; then
    echo "🔧 git is not installed. Installing git..."
    install_pkg git
fi

if ! command_exists python3; then
    echo "🔧 python3 is not installed. Installing python3..."
    install_pkg python3
fi

if ! command_exists nix; then
    echo "🔧 nix is not installed. Installing nix..."
    curl --proto '=https' --tlsv1.2 -L https://nixos.org/nix/install | sh -s -- --daemon
    TARGET_PATH="/nix/var/nix/profiles/default/etc/profile.d/nix-daemon.sh"

    if [ -e "$TARGET_PATH" ]; then
      echo "Nix path exists: '$TARGET_PATH'"
      . "$TARGET_PATH"
    else
      echo "Nix path does not exist: '$TARGET_PATH'" >&2
      exit 1
    fi
fi

if ! command_exists zsh; then
    echo "🔧 zsh is not installed. Installing zsh..."
    install_pkg zsh
    zsh --version
    chsh -s $(which zsh)
fi

for tool in curl git python3 nix zsh; do
  if ! command_exists "$tool"; then
    echo "❌ $tool is still missing after installation." >&2
    exit 1
  fi
done

echo "✅ All prerequisites satisfied."
